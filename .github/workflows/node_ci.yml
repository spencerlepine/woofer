name: Node CI

on:
  workflow_call:

jobs:

  repo_lint:
    name: Lint Code
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false

    steps:
      - name: "☁️ Check out Git Repository"
        uses: actions/checkout@v2

      - name: "🔧 Set up Node"
        uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - uses: actions/cache@v2
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/package-lock.json') }}

      - name: "📦 Install dependencies"
        run: npm install
      - name: "🧽 Lint all files"
        run: npm run lint --if-present

  client_test:
    needs: [repo_lint]
    runs-on: ${{ matrix.os }}
    env:
      working-directory: ./client
    strategy:
      fail-fast: false
      matrix:
        node: ['12', '14', '16']
        os: [ubuntu-latest]

    name: Client CI
    steps:
      - name: "🎯 Print OS and Node version"
        run: echo "Running on ${{ matrix.os }} with Node v${{ matrix.node }}"

      - name: "☁️ Check out Git Repository"
        uses: actions/checkout@v2

      - name: "⚙️ Generate .env file"
        run: |
          mv .env.sample ${{ env.working-directory }}/.env

      - name: "🔧 Set up Node"
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - uses: actions/cache@v2
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/package-lock.json') }}

      - name: "📦 Install dependencies"
        run: npm install

      - name: "✅  Run tests"
        working-directory: ${{ env.working-directory }}
        run: npm run test -- --coverage

      - name: "📁 Upload test coverage artifact"
        uses: actions/upload-artifact@v3
        with:
          name: client-coverage
          path: ${{ env.working-directory }}/coverage/coverage-final.json
          retention-days: 3

      - name: "📁 Upload test LCOV coverage artifact"
        uses: actions/upload-artifact@v3
        with:
          name: client-coverage-lcov
          path: ${{ env.working-directory }}/coverage/lcov.info
          retention-days: 3

  client_build:
    needs: [repo_lint]
    runs-on: ${{ matrix.os }}
    env:
      working-directory: ./client
    strategy:
      fail-fast: false
      matrix:
        node: ['12', '14', '16']
        os: [ubuntu-latest]

    name: Client Build
    steps:
      - name: "☁️ Check out Git Repository"
        uses: actions/checkout@v2

      - name: "⚙️ Generate .env file"
        run: |
          mv .env.sample ${{ env.working-directory }}/.env

      - name: "🔧 Set up Node"
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - uses: actions/cache@v2
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/package-lock.json') }}

      - name: "📦 Install dependencies"
        run: npm install

      - name: "🏗 Build client"
        working-directory: ${{ env.working-directory }}
        run: npm run build --if-present

  server_test:
    needs: [repo_lint]
    runs-on: ${{ matrix.os }}
    env:
      working-directory: ./server
      PORT: 5000
      MONGODB_URL: mongodb://127.0.0.1:27017/test
    strategy:
      fail-fast: false
      matrix:
        node: ['12', '14', '16']
        os: [ubuntu-latest]

    name: Server CI
    steps:
      - name: "🎯 Print OS and Node version"
        run: echo "Running on ${{ matrix.os }} with Node v${{ matrix.node }}"

      - name: "🍃 Create mongoDB Docker container"
        run: sudo docker run -d -p 27017:27017 mongo:latest

      - name: "☁️ Check out Git Repository"
        uses: actions/checkout@v2

      - name: "🔧 Set up Node"
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - uses: actions/cache@v2
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/package-lock.json') }}

      - name: "📦 Install dependencies"
        run: npm install

      - name: "✅  Run tests"
        working-directory: ${{ env.working-directory }}
        run: npm run test -- --coverage

      - name: "📁 Upload test coverage artifact"
        uses: actions/upload-artifact@v3
        with:
          name: server-coverage
          path: ${{ env.working-directory }}/coverage/coverage-final.json
          retention-days: 3

      - name: "📁 Upload test LCOV coverage artifact"
        uses: actions/upload-artifact@v3
        with:
          name: server-coverage-lcov
          path: ${{ env.working-directory }}/coverage/lcov.info
          retention-days: 3

  coverage_comment:
    name: Coverage Upload
    permissions:
      checks: write
      pull-requests: write
    needs: [client_test, server_test]
    runs-on: ubuntu-latest

    steps:
      - name: "⬇️ Download the client test coverage report"
        uses: actions/download-artifact@v3
        with:
          name: client-coverage

      - name: "📜 Copy the client coverage file"
        run: |
          mv coverage-final.json client-coverage-final.json
      - name: "⬇️ Download the server test coverage report"
        uses: actions/download-artifact@v3
        with:
          name: server-coverage

      - name: "📜 Copy the server coverage file"
        run: |
          mv coverage-final.json server-coverage-final.json
      - name: "🔧 Set up Node"
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node }}

      - name: "🔀 Merge the coverage reports"
        run: npx istanbul-merge --out coverage-final.json ./client-coverage-final.json ./server-coverage-final.json

      - name: "⬆️ Comment test coverage report"
        uses: AthleticNet/comment-test-coverage@1.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          path: ./coverage-final.json
          title: Woofer Test Coverage

  coverage_upload:
    name: Coverage Coveralls.io Upload
    needs: [client_test, server_test]
    runs-on: ubuntu-latest

    steps:
      - name: "⬇️ Download the client test coverage lcov report"
        uses: actions/download-artifact@v3
        with:
          name: client-coverage-lcov

      - name: "📜 Copy the client lcov coverage file"
        run: |
          mv lcov.info client-report.lcov
      - name: "⬇️ Download the server test coverage lcov report"
        uses: actions/download-artifact@v3
        with:
          name: server-coverage-lcov

      - name: "📜 Copy the server lcov coverage file"
        run: |
          mv lcov.info server-report.lcov
      - name: "🔧 Set up Node"
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node }}

      - name: "Install lcov report merger package"
        run: npm i lcov-result-merger

      - name: "🔀 Merge the coverage reports"
        run:  ./node_modules/.bin/lcov-result-merger '*-report.lcov' 'lcov.info'

      - name: "🌪️ Publish to coveralls.io"
        uses: coverallsapp/github-action@master
        with:
          path-to-lcov: ./lcov.info
          github-token: ${{ secrets.github_token }}