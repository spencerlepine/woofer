name: Reusable test workflow

env:
  CI: true
  NODE_ENV: development
  PORT: 3000
  MONGODB_URL: mongodb://127.0.0.1:27017/test
  SKIP_PREFLIGHT_CHECK: true
  REACT_APP_FIREBASE_API_KEY: asdf
  REACT_APP_FIREBASE_AUTH_DOMAIN: asdf
  REACT_APP_FIREBASE_PROJECT_ID: asdf
  REACT_APP_FIREBASE_STORAGE_BUCKET: asdf
  REACT_APP_FIREBASE_MESSAGING_SENDER_ID: asdf
  REACT_APP_FIREBASE_APP_ID: asdf
  REACT_APP_FIREBASE_MEASUREMENT_ID: asdf

on:
  workflow_call:
    secrets:
      SUB_FOLDER:
        required: true

jobs:

  test:
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        working-directory: ${{ secrets.SUB_FOLDER }}
    strategy:
      fail-fast: false
      matrix:
        node: ['12', '14', '16']
        os: [ubuntu-latest]

    name: CI
    steps:
      - name: üéØ Print OS and Node version
        run: echo "Running on ${{ matrix.os }} with Node v${{ matrix.node }}"

      - name: üçÉ Create mongoDB Docker container
        run: sudo docker run -d -p 27017:27017 mongo:latest

      - name: ‚ôªÔ∏è Check out Git Repository
        uses: actions/checkout@v2
        with:
          persist-credentials: false

      - name: üîñ Set up Node
        uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node }}

      - name: Cache node modules
        uses: actions/cache@v2
        id: npm_cache_id
        with:
          path: node_modules
          key: ${{ runner.os }}-npm-cache-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-cache-
            ${{ runner.os }}-

      - name: ‚¨áÔ∏è  Install packages
        if: steps.npm_cache_id.outputs.cache-hit != 'true'
        run: npm install

      - name: üßΩ Lint all files
        run: npm run lint

      - name: ‚úÖ  Run tests
        run: npm run test -- --coverage

      - name: üå™Ô∏è Publish to coveralls.io
        uses: coverallsapp/github-action@v1.1.2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}