name: CI/CD

on:
  push:
    branches:
      - main

jobs:

  node_ci:
    uses: ./.github/workflows/node_ci.yml

  docker_ci:
    uses: ./.github/workflows/docker_ci.yml
    secrets:
      ENV_PRODUCTION: ${{ secrets.ENV_PRODUCTION }}
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}

  deploy:
    needs: [node_ci, docker_ci]
    uses: ./.github/workflows/deploy.yml
    secrets:
      ENV_PRODUCTION: ${{ secrets.ENV_PRODUCTION }}
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
      DOCKERHUB_SERVER_REPO: ${{ secrets.DOCKERHUB_SERVER_REPO }}
      DOCKERHUB_CLIENT_REPO: ${{ secrets.DOCKERHUB_CLIENT_REPO }}
      EC2_REMOTE_HOST: ${{ secrets.EC2_REMOTE_HOST }}
      EC2_REMOTE_USER: ${{ secrets.EC2_REMOTE_USER }}
      EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
      EC2_PASSPHRASE: ${{ secrets.EC2_PASSPHRASE }}